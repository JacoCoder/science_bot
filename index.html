<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #4689cc; -webkit-text-stroke: #4689cc}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #8cd3fe; -webkit-text-stroke: #8cd3fe}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #c27e65; -webkit-text-stroke: #c27e65}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #cacaca; -webkit-text-stroke: #cacaca}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #6d7378; -webkit-text-stroke: #6d7378}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #cacaca; -webkit-text-stroke: #cacaca; min-height: 16.0px}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #71c083; -webkit-text-stroke: #71c083}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #71c083; -webkit-text-stroke: #71c083; background-color: #171818}
    span.s1 {font-kerning: none; background-color: #171818}
    span.s2 {font-kerning: none; color: #8cd3fe; background-color: #171818; -webkit-text-stroke: 0px #8cd3fe}
    span.s3 {font-kerning: none; color: #6d6d6d; background-color: #171818; -webkit-text-stroke: 0px #6d6d6d}
    span.s4 {font-kerning: none; color: #cacaca; background-color: #171818; -webkit-text-stroke: 0px #cacaca}
    span.s5 {font-kerning: none; color: #c27e65; background-color: #171818; -webkit-text-stroke: 0px #c27e65}
    span.s6 {font-kerning: none; color: #4689cc; background-color: #171818; -webkit-text-stroke: 0px #4689cc}
    span.s7 {font-kerning: none; color: #d4d4d4; background-color: #171818; -webkit-text-stroke: 0px #d4d4d4}
    span.s8 {font-kerning: none; color: #71c083; background-color: #171818; -webkit-text-stroke: 0px #71c083}
    span.s9 {font-kerning: none; color: #a7c598; background-color: #171818; -webkit-text-stroke: 0px #a7c598}
    span.s10 {font-kerning: none}
    span.s11 {font-kerning: none; color: #b76ff7; background-color: #171818; -webkit-text-stroke: 0px #b76ff7}
    span.s12 {font-kerning: none; color: #36c0a0; background-color: #171818; -webkit-text-stroke: 0px #36c0a0}
    span.s13 {font-kerning: none; color: #6d7378; background-color: #171818; -webkit-text-stroke: 0px #6d7378}
    span.s14 {font-kerning: none; color: #f67c30; background-color: #171818; -webkit-text-stroke: 0px #f67c30}
    span.s15 {font-kerning: none; color: #a34f83; background-color: #171818; -webkit-text-stroke: 0px #a34f83}
    span.s16 {font-kerning: none; color: #cacaca; -webkit-text-stroke: 0px #cacaca}
    span.s17 {font-kerning: none; color: #d4d4d4; -webkit-text-stroke: 0px #d4d4d4}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE</span><span class="s2"> html</span><span class="s1">&gt;</span></p>
<p class="p1"><span class="s3">&lt;</span><span class="s1">html</span><span class="s4"> </span><span class="s2">lang</span><span class="s3">=</span><span class="s5">"en"</span><span class="s3">&gt;</span></p>
<p class="p1"><span class="s3">&lt;</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">meta</span><span class="s4"> </span><span class="s1">charset</span><span class="s3">=</span><span class="s5">"UTF-8"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">meta</span><span class="s4"> </span><span class="s2">name</span><span class="s3">=</span><span class="s1">"viewport"</span><span class="s4"> </span><span class="s2">content</span><span class="s3">=</span><span class="s1">"width=device-width, initial-scale=1.0"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">title</span><span class="s3">&gt;</span><span class="s1">Gemini AI Chatbot</span><span class="s3">&lt;/</span><span class="s6">title</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">&lt;!-- Load Tailwind CSS --&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">script</span><span class="s4"> </span><span class="s2">src</span><span class="s3">=</span><span class="s1">"https://cdn.tailwindcss.com"</span><span class="s3">&gt;&lt;/</span><span class="s6">script</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s1">&lt;!-- Use Inter font family --&gt;</span></p>
<p class="p1"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s6">body</span><span class="s4"> </span><span class="s7">{</span><span class="s4"> </span><span class="s1">font-family:</span><span class="s4"> </span><span class="s8">'Inter'</span><span class="s7">,</span><span class="s4"> </span><span class="s5">sans-serif</span><span class="s7">;</span><span class="s4"> </span><span class="s1">background-color:</span><span class="s4"> #f7fafc</span><span class="s7">;</span><span class="s4"> </span><span class="s7">}</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s6">.chat-area</span><span class="s4"> </span><span class="s7">{</span><span class="s4"> </span><span class="s1">max-height:</span><span class="s4"> </span><span class="s5">calc(</span><span class="s9">100vh</span><span class="s4"> </span><span class="s7">-</span><span class="s4"> </span><span class="s9">12rem</span><span class="s5">)</span><span class="s7">;</span><span class="s4"> </span><span class="s1">overflow-y:</span><span class="s4"> </span><span class="s5">auto</span><span class="s7">;</span><span class="s4"> </span><span class="s7">}</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s6">.user-message</span><span class="s4"> </span><span class="s7">{</span><span class="s4"> </span><span class="s1">background-color:</span><span class="s4"> #3b82f6</span><span class="s7">;</span><span class="s4"> </span><span class="s1">color:</span><span class="s4"> </span><span class="s5">white</span><span class="s7">;</span><span class="s4"> </span><span class="s1">border-radius:</span><span class="s4"> </span><span class="s9">12px</span><span class="s4"> </span><span class="s9">12px</span><span class="s4"> </span><span class="s9">0</span><span class="s4"> </span><span class="s9">12px</span><span class="s7">;</span><span class="s4"> </span><span class="s7">}</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s6">.model-message</span><span class="s4"> </span><span class="s7">{</span><span class="s4"> </span><span class="s1">background-color:</span><span class="s4"> #e5e7eb</span><span class="s7">;</span><span class="s4"> </span><span class="s1">color:</span><span class="s4"> #1f2937</span><span class="s7">;</span><span class="s4"> </span><span class="s1">border-radius:</span><span class="s4"> </span><span class="s9">12px</span><span class="s4"> </span><span class="s9">12px</span><span class="s4"> </span><span class="s9">12px</span><span class="s4"> </span><span class="s9">0</span><span class="s7">;</span><span class="s4"> </span><span class="s7">}</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">/* Custom scrollbar for chat-area */</span></p>
<p class="p1"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">.chat-area::-webkit-scrollbar</span><span class="s4"> </span><span class="s7">{</span><span class="s4"> </span><span class="s2">width:</span><span class="s4"> </span><span class="s9">8px</span><span class="s7">;</span><span class="s4"> </span><span class="s7">}</span></p>
<p class="p1"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">.chat-area::-webkit-scrollbar-thumb</span><span class="s4"> </span><span class="s7">{</span><span class="s4"> </span><span class="s2">background:</span><span class="s4"> #cbd5e1</span><span class="s7">;</span><span class="s4"> </span><span class="s2">border-radius:</span><span class="s4"> </span><span class="s9">10px</span><span class="s7">;</span><span class="s4"> </span><span class="s7">}</span></p>
<p class="p1"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">.chat-area::-webkit-scrollbar-track</span><span class="s4"> </span><span class="s7">{</span><span class="s4"> </span><span class="s2">background:</span><span class="s4"> #f1f1f1</span><span class="s7">;</span><span class="s4"> </span><span class="s7">}</span></p>
<p class="p1"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;/</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p1"><span class="s3">&lt;/</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;</span><span class="s6">body</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"min-h-screen flex flex-col items-center p-4 bg-gray-100"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">div</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"w-full max-w-2xl bg-white shadow-xl rounded-xl flex flex-col h-[90vh]"</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">&lt;!-- Header --&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">header</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"p-4 bg-indigo-600 text-white rounded-t-xl shadow-md"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">h1</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"text-2xl font-bold"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">span</span><span class="s1"> </span><span class="s2">class</span><span class="s3">=</span><span class="s5">"inline-block align-middle"</span><span class="s3">&gt;</span><span class="s1">ðŸ”¬ Professor McGonnagal's Misconception Cycle</span><span class="s3">&lt;/</span><span class="s6">span</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">h1</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">p</span><span class="s4"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"user-id-display"</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"text-xs mt-1 opacity-75 truncate"</span><span class="s3">&gt;</span><span class="s4">Initializing...</span><span class="s3">&lt;/</span><span class="s6">p</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">header</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">&lt;!-- Chat Messages Area --&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">main</span><span class="s4"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"chat-area"</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"chat-area flex-grow p-4 space-y-4"</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">&lt;!-- Messages will be injected here --&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">div</span><span class="s4"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"loading-initial"</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"flex justify-center items-center h-full text-gray-500"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">svg</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500"</span><span class="s4"> </span><span class="s2">xmlns</span><span class="s3">=</span><span class="s1">"http://www.w3.org/2000/svg"</span><span class="s4"> </span><span class="s2">fill</span><span class="s3">=</span><span class="s1">"none"</span><span class="s4"> </span><span class="s2">viewBox</span><span class="s3">=</span><span class="s1">"0 0 24 24"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">circle</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"opacity-25"</span><span class="s4"> </span><span class="s2">cx</span><span class="s3">=</span><span class="s1">"12"</span><span class="s4"> </span><span class="s2">cy</span><span class="s3">=</span><span class="s1">"12"</span><span class="s4"> </span><span class="s2">r</span><span class="s3">=</span><span class="s1">"10"</span><span class="s4"> </span><span class="s2">stroke</span><span class="s3">=</span><span class="s1">"currentColor"</span><span class="s4"> </span><span class="s2">stroke-width</span><span class="s3">=</span><span class="s1">"4"</span><span class="s3">&gt;&lt;/</span><span class="s6">circle</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">path</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"opacity-75"</span><span class="s4"> </span><span class="s2">fill</span><span class="s3">=</span><span class="s1">"currentColor"</span><span class="s4"> </span><span class="s2">d</span><span class="s3">=</span><span class="s1">"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"</span><span class="s3">&gt;&lt;/</span><span class="s6">path</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">svg</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>Loading chat history...</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">main</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">&lt;!-- Input Area --&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">footer</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"p-4 border-t border-gray-200 bg-white rounded-b-xl"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">form</span><span class="s4"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"chat-form"</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"flex gap-2"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">input</span><span class="s4"> </span><span class="s2">type</span><span class="s3">=</span><span class="s1">"text"</span><span class="s4"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"user-input"</span><span class="s4"> </span><span class="s2">placeholder</span><span class="s3">=</span><span class="s1">"Enter your name and confirm you are ready to begin..."</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s2">class</span><span class="s3">=</span><span class="s1">"flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s2">autocomplete</span><span class="s3">=</span><span class="s5">"off"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">button</span><span class="s4"> </span><span class="s2">type</span><span class="s3">=</span><span class="s1">"submit"</span><span class="s4"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"send-button"</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s2">class</span><span class="s3">=</span><span class="s1">"bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400"</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s2">title</span><span class="s3">=</span><span class="s5">"Send Message"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">svg</span><span class="s4"> </span><span class="s2">xmlns</span><span class="s3">=</span><span class="s1">"http://www.w3.org/2000/svg"</span><span class="s4"> </span><span class="s2">width</span><span class="s3">=</span><span class="s1">"24"</span><span class="s4"> </span><span class="s2">height</span><span class="s3">=</span><span class="s1">"24"</span><span class="s4"> </span><span class="s2">viewBox</span><span class="s3">=</span><span class="s1">"0 0 24 24"</span><span class="s4"> </span><span class="s2">fill</span><span class="s3">=</span><span class="s1">"none"</span><span class="s4"> </span><span class="s2">stroke</span><span class="s3">=</span><span class="s1">"currentColor"</span><span class="s4"> </span><span class="s2">stroke-width</span><span class="s3">=</span><span class="s1">"2"</span><span class="s4"> </span><span class="s2">stroke-linecap</span><span class="s3">=</span><span class="s1">"round"</span><span class="s4"> </span><span class="s2">stroke-linejoin</span><span class="s3">=</span><span class="s1">"round"</span><span class="s3">&gt;&lt;</span><span class="s6">line</span><span class="s4"> </span><span class="s2">x1</span><span class="s3">=</span><span class="s1">"22"</span><span class="s4"> </span><span class="s2">y1</span><span class="s3">=</span><span class="s1">"2"</span><span class="s4"> </span><span class="s2">x2</span><span class="s3">=</span><span class="s1">"11"</span><span class="s4"> </span><span class="s2">y2</span><span class="s3">=</span><span class="s1">"13"</span><span class="s3">&gt;&lt;/</span><span class="s6">line</span><span class="s3">&gt;&lt;</span><span class="s6">polygon</span><span class="s4"> </span><span class="s2">points</span><span class="s3">=</span><span class="s1">"22 2 15 22 11 13 2 9 22 2"</span><span class="s3">&gt;&lt;/</span><span class="s6">polygon</span><span class="s3">&gt;&lt;/</span><span class="s6">svg</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">button</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">form</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">p</span><span class="s4"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"error-message"</span><span class="s4"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"text-sm text-red-500 mt-2 hidden"</span><span class="s3">&gt;&lt;/</span><span class="s6">p</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">footer</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;/</span><span class="s6">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;</span><span class="s6">script</span><span class="s4"> </span><span class="s2">type</span><span class="s3">=</span><span class="s1">"module"</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// --- FIREBASE IMPORTS ---</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">import</span><span class="s4"> </span><span class="s7">{</span><span class="s4"> initializeApp </span><span class="s7">}</span><span class="s4"> </span><span class="s11">from</span><span class="s4"> </span><span class="s1">"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">import</span><span class="s1"> </span><span class="s7">{</span><span class="s1"> getAuth</span><span class="s7">,</span><span class="s1"> signInAnonymously</span><span class="s7">,</span><span class="s1"> signInWithCustomToken</span><span class="s7">,</span><span class="s1"> onAuthStateChanged </span><span class="s7">}</span><span class="s1"> </span><span class="s11">from</span><span class="s1"> </span><span class="s8">"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">import</span><span class="s1"> </span><span class="s7">{</span><span class="s1"> getFirestore</span><span class="s7">,</span><span class="s1"> doc</span><span class="s7">,</span><span class="s1"> addDoc</span><span class="s7">,</span><span class="s1"> onSnapshot</span><span class="s7">,</span><span class="s1"> collection</span><span class="s7">,</span><span class="s1"> query</span><span class="s7">,</span><span class="s1"> orderBy</span><span class="s7">,</span><span class="s1"> setLogLevel</span><span class="s7">,</span><span class="s1"> serverTimestamp </span><span class="s7">}</span><span class="s1"> </span><span class="s11">from</span><span class="s1"> </span><span class="s8">"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// Global variables provided by the environment</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> appId </span><span class="s7">=</span><span class="s1"> </span><span class="s11">typeof</span><span class="s1"> __app_id </span><span class="s7">!==</span><span class="s1"> </span><span class="s8">'undefined'</span><span class="s1"> </span><span class="s7">?</span><span class="s1"> __app_id </span><span class="s7">:</span><span class="s1"> </span><span class="s8">'default-app-id'</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> firebaseConfig </span><span class="s7">=</span><span class="s1"> </span><span class="s12">JSON</span><span class="s7">.</span><span class="s1">parse</span><span class="s7">(</span><span class="s11">typeof</span><span class="s1"> __firebase_config </span><span class="s7">!==</span><span class="s1"> </span><span class="s8">'undefined'</span><span class="s1"> </span><span class="s7">?</span><span class="s1"> __firebase_config </span><span class="s7">:</span><span class="s1"> </span><span class="s8">'{}'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> initialAuthToken </span><span class="s7">=</span><span class="s1"> </span><span class="s11">typeof</span><span class="s1"> __initial_auth_token </span><span class="s7">!==</span><span class="s1"> </span><span class="s8">'undefined'</span><span class="s1"> </span><span class="s7">?</span><span class="s1"> __initial_auth_token </span><span class="s7">:</span><span class="s1"> </span><span class="s11">null</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// Configuration</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s4"> </span><span class="s12">MODEL_NAME</span><span class="s4"> </span><span class="s7">=</span><span class="s4"> </span><span class="s1">"gemini-2.5-flash-preview-09-2025"</span><span class="s7">;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s4"> </span><span class="s12">API_BASE_URL</span><span class="s4"> </span><span class="s7">=</span><span class="s4"> </span><span class="s1">`https://generativelanguage.googleapis.com/v1beta/models/</span><span class="s7">${</span><span class="s12">MODEL_NAME</span><span class="s7">}</span><span class="s1">:generateContent`</span><span class="s7">;</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s4"> </span><span class="s12">API_KEY</span><span class="s4"> </span><span class="s7">=</span><span class="s4"> </span><span class="s8">""</span><span class="s7">;</span><span class="s4"> </span><span class="s1">// Canvas environment will provide the key if empty</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// UI elements</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> chatArea </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">getElementById</span><span class="s7">(</span><span class="s8">'chat-area'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> chatForm </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">getElementById</span><span class="s7">(</span><span class="s8">'chat-form'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> userInput </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">getElementById</span><span class="s7">(</span><span class="s8">'user-input'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> sendButton </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">getElementById</span><span class="s7">(</span><span class="s8">'send-button'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> errorDisplay </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">getElementById</span><span class="s7">(</span><span class="s8">'error-message'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> userIdDisplay </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">getElementById</span><span class="s7">(</span><span class="s8">'user-id-display'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> loadingInitial </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">getElementById</span><span class="s7">(</span><span class="s8">'loading-initial'</span><span class="s7">);</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">// State</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">let</span><span class="s1"> db</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">let</span><span class="s1"> auth</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">let</span><span class="s1"> userId </span><span class="s7">=</span><span class="s1"> </span><span class="s11">null</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">let</span><span class="s1"> isAuthReady </span><span class="s7">=</span><span class="s1"> </span><span class="s11">false</span><span class="s7">;</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">let</span><span class="s4"> conversationHistory </span><span class="s7">=</span><span class="s4"> </span><span class="s7">[];</span><span class="s4"> </span><span class="s1">// Stores the history in Firestore format for UI display</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">let</span><span class="s1"> isAITyping </span><span class="s7">=</span><span class="s1"> </span><span class="s11">false</span><span class="s7">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// --- UTILITY FUNCTIONS ---</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Implements exponential backoff for retrying failed API calls.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {function} callback - The function that performs the fetch request.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {number} maxRetries - Maximum number of retries.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">async</span><span class="s1"> </span><span class="s11">function</span><span class="s1"> fetchWithRetry</span><span class="s7">(</span><span class="s1">callback</span><span class="s7">,</span><span class="s1"> maxRetries </span><span class="s7">=</span><span class="s1"> </span><span class="s14">5</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">for</span><span class="s1"> </span><span class="s7">(</span><span class="s11">let</span><span class="s1"> i </span><span class="s7">=</span><span class="s1"> </span><span class="s14">0</span><span class="s7">;</span><span class="s1"> i </span><span class="s7">&lt;</span><span class="s1"> maxRetries</span><span class="s7">;</span><span class="s1"> i</span><span class="s7">++)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">try</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> response </span><span class="s7">=</span><span class="s1"> </span><span class="s11">await</span><span class="s1"> callback</span><span class="s7">();</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">response</span><span class="s7">.</span><span class="s1">status </span><span class="s7">===</span><span class="s1"> </span><span class="s14">429</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Too Many Requests, retry</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> delay </span><span class="s7">=</span><span class="s1"> </span><span class="s12">Math</span><span class="s7">.</span><span class="s1">pow</span><span class="s7">(</span><span class="s14">2</span><span class="s7">,</span><span class="s1"> i</span><span class="s7">)</span><span class="s1"> </span><span class="s7">*</span><span class="s1"> </span><span class="s14">1000</span><span class="s1"> </span><span class="s7">+</span><span class="s1"> </span><span class="s12">Math</span><span class="s7">.</span><span class="s1">random</span><span class="s7">()</span><span class="s1"> </span><span class="s7">*</span><span class="s1"> </span><span class="s14">1000</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>console</span><span class="s7">.</span><span class="s1">warn</span><span class="s7">(</span><span class="s8">`Rate limit hit (429). Retrying in </span><span class="s7">${</span><span class="s12">Math</span><span class="s7">.</span><span class="s1">round</span><span class="s7">(</span><span class="s1">delay</span><span class="s7">/</span><span class="s14">1000</span><span class="s7">)}</span><span class="s8">s...`</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">await</span><span class="s1"> </span><span class="s11">new</span><span class="s1"> </span><span class="s12">Promise</span><span class="s7">(</span><span class="s1">resolve </span><span class="s7">=&gt;</span><span class="s1"> setTimeout</span><span class="s7">(</span><span class="s1">resolve</span><span class="s7">,</span><span class="s1"> delay</span><span class="s7">));</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">continue</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(!</span><span class="s1">response</span><span class="s7">.</span><span class="s1">ok</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> errorBody </span><span class="s7">=</span><span class="s1"> </span><span class="s11">await</span><span class="s1"> response</span><span class="s7">.</span><span class="s1">text</span><span class="s7">();</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">throw</span><span class="s1"> </span><span class="s11">new</span><span class="s1"> </span><span class="s12">Error</span><span class="s7">(</span><span class="s8">`API Error: </span><span class="s7">${</span><span class="s1">response</span><span class="s7">.</span><span class="s1">status</span><span class="s7">}</span><span class="s8"> - </span><span class="s7">${</span><span class="s1">errorBody</span><span class="s7">}</span><span class="s8">`</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">return</span><span class="s1"> response</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">catch</span><span class="s1"> </span><span class="s7">(</span><span class="s1">error</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">i </span><span class="s7">===</span><span class="s1"> maxRetries </span><span class="s7">-</span><span class="s1"> </span><span class="s14">1</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">throw</span><span class="s4"> error</span><span class="s7">;</span><span class="s4"> </span><span class="s1">// Throw the error if max retries reached</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> delay </span><span class="s7">=</span><span class="s1"> </span><span class="s12">Math</span><span class="s7">.</span><span class="s1">pow</span><span class="s7">(</span><span class="s14">2</span><span class="s7">,</span><span class="s1"> i</span><span class="s7">)</span><span class="s1"> </span><span class="s7">*</span><span class="s1"> </span><span class="s14">1000</span><span class="s1"> </span><span class="s7">+</span><span class="s1"> </span><span class="s12">Math</span><span class="s7">.</span><span class="s1">random</span><span class="s7">()</span><span class="s1"> </span><span class="s7">*</span><span class="s1"> </span><span class="s14">1000</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>console</span><span class="s7">.</span><span class="s1">error</span><span class="s7">(</span><span class="s8">`Attempt </span><span class="s7">${</span><span class="s1">i </span><span class="s7">+</span><span class="s1"> </span><span class="s14">1</span><span class="s7">}</span><span class="s8"> failed. Retrying in </span><span class="s7">${</span><span class="s12">Math</span><span class="s7">.</span><span class="s1">round</span><span class="s7">(</span><span class="s1">delay</span><span class="s7">/</span><span class="s14">1000</span><span class="s7">)}</span><span class="s8">s. Error: </span><span class="s7">${</span><span class="s1">error</span><span class="s7">.</span><span class="s1">message</span><span class="s7">}</span><span class="s8">`</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">await</span><span class="s1"> </span><span class="s11">new</span><span class="s1"> </span><span class="s12">Promise</span><span class="s7">(</span><span class="s1">resolve </span><span class="s7">=&gt;</span><span class="s1"> setTimeout</span><span class="s7">(</span><span class="s1">resolve</span><span class="s7">,</span><span class="s1"> delay</span><span class="s7">));</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// --- FIREBASE / AUTHENTICATION ---</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Initializes Firebase and authenticates the user.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">function</span><span class="s1"> initializeFirebase</span><span class="s7">()</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">try</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// setLogLevel('debug'); // Uncomment for debugging Firestore/Auth issues</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> app </span><span class="s7">=</span><span class="s1"> initializeApp</span><span class="s7">(</span><span class="s1">firebaseConfig</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>db </span><span class="s7">=</span><span class="s1"> getFirestore</span><span class="s7">(</span><span class="s1">app</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>auth </span><span class="s7">=</span><span class="s1"> getAuth</span><span class="s7">(</span><span class="s1">app</span><span class="s7">);</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Listen for authentication state changes</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>onAuthStateChanged</span><span class="s7">(</span><span class="s1">auth</span><span class="s7">,</span><span class="s1"> </span><span class="s11">async</span><span class="s1"> </span><span class="s7">(</span><span class="s1">user</span><span class="s7">)</span><span class="s1"> </span><span class="s7">=&gt;</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">user</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>userId </span><span class="s7">=</span><span class="s1"> user</span><span class="s7">.</span><span class="s1">uid</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>isAuthReady </span><span class="s7">=</span><span class="s1"> </span><span class="s11">true</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>userIdDisplay</span><span class="s7">.</span><span class="s1">textContent </span><span class="s7">=</span><span class="s1"> </span><span class="s8">`User ID: </span><span class="s7">${</span><span class="s1">userId</span><span class="s7">}</span><span class="s8">`</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>setupRealtimeChatListener</span><span class="s7">();</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">else</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Attempt to sign in if not already authenticated</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">initialAuthToken</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">await</span><span class="s1"> signInWithCustomToken</span><span class="s7">(</span><span class="s1">auth</span><span class="s7">,</span><span class="s1"> initialAuthToken</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">else</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Fallback to anonymous sign-in if no custom token is provided</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">await</span><span class="s1"> signInAnonymously</span><span class="s7">(</span><span class="s1">auth</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">});</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Force sign-in attempt if not started by onAuthStateChanged</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(!</span><span class="s1">auth</span><span class="s7">.</span><span class="s1">currentUser</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">initialAuthToken</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>signInWithCustomToken</span><span class="s7">(</span><span class="s1">auth</span><span class="s7">,</span><span class="s1"> initialAuthToken</span><span class="s7">).</span><span class="s11">catch</span><span class="s7">(</span><span class="s1">e </span><span class="s7">=&gt;</span><span class="s1"> console</span><span class="s7">.</span><span class="s1">error</span><span class="s7">(</span><span class="s8">"Custom Auth failed:"</span><span class="s7">,</span><span class="s1"> e</span><span class="s7">));</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">else</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>signInAnonymously</span><span class="s7">(</span><span class="s1">auth</span><span class="s7">).</span><span class="s11">catch</span><span class="s7">(</span><span class="s1">e </span><span class="s7">=&gt;</span><span class="s1"> console</span><span class="s7">.</span><span class="s1">error</span><span class="s7">(</span><span class="s8">"Anonymous Auth failed:"</span><span class="s7">,</span><span class="s1"> e</span><span class="s7">));</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">catch</span><span class="s1"> </span><span class="s7">(</span><span class="s1">e</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>console</span><span class="s7">.</span><span class="s4">error</span><span class="s7">(</span><span class="s1">"Firebase Initialization Error:"</span><span class="s7">,</span><span class="s4"> e</span><span class="s7">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>loadingInitial</span><span class="s7">.</span><span class="s4">innerHTML </span><span class="s7">=</span><span class="s4"> </span><span class="s1">`&lt;p class="text-red-500"&gt;Error initializing application. See console for details.&lt;/p&gt;`</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// --- FIRESTORE CHAT MANAGEMENT ---</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Sets up the real-time listener for the chat history.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">function</span><span class="s1"> setupRealtimeChatListener</span><span class="s7">()</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(!</span><span class="s1">isAuthReady </span><span class="s7">||</span><span class="s1"> </span><span class="s7">!</span><span class="s1">userId</span><span class="s7">)</span><span class="s1"> </span><span class="s11">return</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Path for private user messages: /artifacts/{appId}/users/{userId}/messages</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> chatCollectionRef </span><span class="s7">=</span><span class="s1"> collection</span><span class="s7">(</span><span class="s1">db</span><span class="s7">,</span><span class="s1"> </span><span class="s8">`artifacts/</span><span class="s7">${</span><span class="s1">appId</span><span class="s7">}</span><span class="s8">/users/</span><span class="s7">${</span><span class="s1">userId</span><span class="s7">}</span><span class="s8">/messages`</span><span class="s7">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Query ordered by timestamp</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> q </span><span class="s7">=</span><span class="s1"> query</span><span class="s7">(</span><span class="s1">chatCollectionRef</span><span class="s7">,</span><span class="s1"> orderBy</span><span class="s7">(</span><span class="s8">'timestamp'</span><span class="s7">,</span><span class="s1"> </span><span class="s8">'asc'</span><span class="s7">));</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>onSnapshot</span><span class="s7">(</span><span class="s1">q</span><span class="s7">,</span><span class="s1"> </span><span class="s7">(</span><span class="s1">snapshot</span><span class="s7">)</span><span class="s1"> </span><span class="s7">=&gt;</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> updatedHistory </span><span class="s7">=</span><span class="s1"> </span><span class="s7">[];</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>snapshot</span><span class="s7">.</span><span class="s1">forEach</span><span class="s7">((</span><span class="s1">doc</span><span class="s7">)</span><span class="s1"> </span><span class="s7">=&gt;</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>updatedHistory</span><span class="s7">.</span><span class="s1">push</span><span class="s7">({</span><span class="s1"> id</span><span class="s7">:</span><span class="s1"> doc</span><span class="s7">.</span><span class="s1">id</span><span class="s7">,</span><span class="s1"> </span><span class="s7">...</span><span class="s1">doc</span><span class="s7">.</span><span class="s1">data</span><span class="s7">()</span><span class="s1"> </span><span class="s7">});</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">});</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>conversationHistory </span><span class="s7">=</span><span class="s1"> updatedHistory</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>renderChat</span><span class="s7">(</span><span class="s1">conversationHistory</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>loadingInitial</span><span class="s7">.</span><span class="s1">classList</span><span class="s7">.</span><span class="s1">add</span><span class="s7">(</span><span class="s8">'hidden'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">},</span><span class="s1"> </span><span class="s7">(</span><span class="s1">error</span><span class="s7">)</span><span class="s1"> </span><span class="s7">=&gt;</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>console</span><span class="s7">.</span><span class="s1">error</span><span class="s7">(</span><span class="s8">"Firestore real-time error:"</span><span class="s7">,</span><span class="s1"> error</span><span class="s7">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>loadingInitial</span><span class="s7">.</span><span class="s4">innerHTML </span><span class="s7">=</span><span class="s4"> </span><span class="s1">`&lt;p class="text-red-500"&gt;Error loading chat history. See console for details.&lt;/p&gt;`</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">});</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Adds a new message to Firestore.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {string} role - 'user' or 'model'.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {string} text - The message content.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">async</span><span class="s1"> </span><span class="s11">function</span><span class="s1"> addMessageToFirestore</span><span class="s7">(</span><span class="s1">role</span><span class="s7">,</span><span class="s1"> text</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(!</span><span class="s1">db </span><span class="s7">||</span><span class="s1"> </span><span class="s7">!</span><span class="s1">userId</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>console</span><span class="s7">.</span><span class="s4">error</span><span class="s7">(</span><span class="s1">"Database or User ID not available."</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">return</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> chatCollectionRef </span><span class="s7">=</span><span class="s1"> collection</span><span class="s7">(</span><span class="s1">db</span><span class="s7">,</span><span class="s1"> </span><span class="s8">`artifacts/</span><span class="s7">${</span><span class="s1">appId</span><span class="s7">}</span><span class="s8">/users/</span><span class="s7">${</span><span class="s1">userId</span><span class="s7">}</span><span class="s8">/messages`</span><span class="s7">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">try</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">await</span><span class="s1"> addDoc</span><span class="s7">(</span><span class="s1">chatCollectionRef</span><span class="s7">,</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>role</span><span class="s7">:</span><span class="s1"> role</span><span class="s7">,</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>text</span><span class="s7">:</span><span class="s1"> text</span><span class="s7">,</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>timestamp</span><span class="s7">:</span><span class="s1"> serverTimestamp</span><span class="s7">()</span><span class="s1"> </span><span class="s13">// Use server timestamp for accurate ordering</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">});</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">catch</span><span class="s1"> </span><span class="s7">(</span><span class="s1">e</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>console</span><span class="s7">.</span><span class="s1">error</span><span class="s7">(</span><span class="s8">"Error adding document: "</span><span class="s7">,</span><span class="s1"> e</span><span class="s7">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>showError</span><span class="s7">(</span><span class="s1">"Failed to save message to history."</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// --- UI RENDERING ---</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Renders the entire chat history to the UI.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {Array&lt;Object&gt;} history - The conversation history array.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">function</span><span class="s1"> renderChat</span><span class="s7">(</span><span class="s1">history</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>chatArea</span><span class="s7">.</span><span class="s1">innerHTML </span><span class="s7">=</span><span class="s1"> </span><span class="s8">''</span><span class="s7">;</span><span class="s1"> </span><span class="s13">// Clear existing messages</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>history</span><span class="s7">.</span><span class="s1">forEach</span><span class="s7">(</span><span class="s1">message </span><span class="s7">=&gt;</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> messageElement </span><span class="s7">=</span><span class="s1"> createMessageElement</span><span class="s7">(</span><span class="s1">message</span><span class="s7">.</span><span class="s1">role</span><span class="s7">,</span><span class="s1"> message</span><span class="s7">.</span><span class="s1">text</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>chatArea</span><span class="s7">.</span><span class="s1">appendChild</span><span class="s7">(</span><span class="s1">messageElement</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">});</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Add the temporary typing indicator if needed</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">isAITyping</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> typingIndicator </span><span class="s7">=</span><span class="s1"> createTypingIndicator</span><span class="s7">();</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â  Â  Â  </span>chatArea</span><span class="s7">.</span><span class="s1">appendChild</span><span class="s7">(</span><span class="s1">typingIndicator</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Scroll to the bottom</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>chatArea</span><span class="s7">.</span><span class="s1">scrollTop </span><span class="s7">=</span><span class="s1"> chatArea</span><span class="s7">.</span><span class="s1">scrollHeight</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Creates a single chat message element.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {string} role - 'user' or 'model'.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {string} text - The message content.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @returns {HTMLElement} The created div element.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">function</span><span class="s1"> createMessageElement</span><span class="s7">(</span><span class="s1">role</span><span class="s7">,</span><span class="s1"> text</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> isUser </span><span class="s7">=</span><span class="s1"> role </span><span class="s7">===</span><span class="s1"> </span><span class="s8">'user'</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> messageWrapper </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">createElement</span><span class="s7">(</span><span class="s8">'div'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageWrapper</span><span class="s7">.</span><span class="s1">className </span><span class="s7">=</span><span class="s1"> </span><span class="s8">`flex </span><span class="s7">${</span><span class="s1">isUser </span><span class="s7">?</span><span class="s1"> </span><span class="s8">'justify-end'</span><span class="s1"> </span><span class="s7">:</span><span class="s1"> </span><span class="s8">'justify-start'</span><span class="s7">}</span><span class="s8">`</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> messageBubble </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">createElement</span><span class="s7">(</span><span class="s8">'div'</span><span class="s7">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageBubble</span><span class="s7">.</span><span class="s4">className </span><span class="s7">=</span><span class="s4"> </span><span class="s1">`max-w-[80%] p-3 shadow-md </span><span class="s7">${</span><span class="s4">isUser </span><span class="s7">?</span><span class="s4"> </span><span class="s1">'user-message'</span><span class="s4"> </span><span class="s7">:</span><span class="s4"> </span><span class="s1">'model-message'</span><span class="s7">}</span><span class="s1">`</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageBubble</span><span class="s7">.</span><span class="s1">innerHTML </span><span class="s7">=</span><span class="s1"> formatText</span><span class="s7">(</span><span class="s1">text</span><span class="s7">);</span><span class="s1"> </span><span class="s13">// Use innerHTML for Markdown</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageWrapper</span><span class="s7">.</span><span class="s1">appendChild</span><span class="s7">(</span><span class="s1">messageBubble</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">return</span><span class="s1"> messageWrapper</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Creates a simple typing indicator.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">function</span><span class="s1"> createTypingIndicator</span><span class="s7">()</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> messageWrapper </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">createElement</span><span class="s7">(</span><span class="s8">'div'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageWrapper</span><span class="s7">.</span><span class="s1">id </span><span class="s7">=</span><span class="s1"> </span><span class="s8">'typing-indicator'</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageWrapper</span><span class="s7">.</span><span class="s1">className </span><span class="s7">=</span><span class="s1"> </span><span class="s8">'flex justify-start'</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> messageBubble </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">createElement</span><span class="s7">(</span><span class="s8">'div'</span><span class="s7">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageBubble</span><span class="s7">.</span><span class="s4">className </span><span class="s7">=</span><span class="s4"> </span><span class="s1">'max-w-[80%] p-3 shadow-md model-message'</span><span class="s7">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Simple pulsating dots</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageBubble</span><span class="s7">.</span><span class="s1">innerHTML </span><span class="s7">=</span><span class="s1"> </span><span class="s8">`</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;span class="inline-block h-2 w-2 bg-gray-600 rounded-full animate-pulse mx-0.5"&gt;&lt;/span&gt;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;span class="inline-block h-2 w-2 bg-gray-600 rounded-full animate-pulse mx-0.5" style="animation-delay: 0.2s;"&gt;&lt;/span&gt;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;span class="inline-block h-2 w-2 bg-gray-600 rounded-full animate-pulse mx-0.5" style="animation-delay: 0.4s;"&gt;&lt;/span&gt;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>`</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>messageWrapper</span><span class="s7">.</span><span class="s1">appendChild</span><span class="s7">(</span><span class="s1">messageBubble</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">return</span><span class="s1"> messageWrapper</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Basic text formatting (handles newlines).</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">function</span><span class="s1"> formatText</span><span class="s7">(</span><span class="s1">text</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Replace newlines with &lt;br&gt; for simple multi-line display</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">return</span><span class="s1"> text</span><span class="s7">.</span><span class="s1">replace</span><span class="s7">(</span><span class="s15">/\n/</span><span class="s11">g</span><span class="s7">,</span><span class="s1"> </span><span class="s8">'&lt;br&gt;'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Displays a temporary error message in the footer.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {string} message - The error message.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">function</span><span class="s1"> showError</span><span class="s7">(</span><span class="s1">message</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>errorDisplay</span><span class="s7">.</span><span class="s1">textContent </span><span class="s7">=</span><span class="s1"> </span><span class="s8">`Error: </span><span class="s7">${</span><span class="s1">message</span><span class="s7">}</span><span class="s8">`</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>errorDisplay</span><span class="s7">.</span><span class="s1">classList</span><span class="s7">.</span><span class="s1">remove</span><span class="s7">(</span><span class="s8">'hidden'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>setTimeout</span><span class="s7">(()</span><span class="s1"> </span><span class="s7">=&gt;</span><span class="s1"> errorDisplay</span><span class="s7">.</span><span class="s1">classList</span><span class="s7">.</span><span class="s1">add</span><span class="s7">(</span><span class="s8">'hidden'</span><span class="s7">),</span><span class="s1"> </span><span class="s14">5000</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// --- GEMINI API INTEGRATION ---</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Calls the Gemini API to get a response.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {Array&lt;Object&gt;} history - The conversation history.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {string} userMessage - The latest user message.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">async</span><span class="s1"> </span><span class="s11">function</span><span class="s1"> getGeminiResponse</span><span class="s7">(</span><span class="s1">history</span><span class="s7">,</span><span class="s1"> userMessage</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Map the Firestore history structure to the Gemini API contents structure</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> contents </span><span class="s7">=</span><span class="s1"> history</span><span class="s7">.</span><span class="s1">map</span><span class="s7">(</span><span class="s1">msg </span><span class="s7">=&gt;</span><span class="s1"> </span><span class="s7">({</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>role</span><span class="s7">:</span><span class="s1"> msg</span><span class="s7">.</span><span class="s1">role</span><span class="s7">,</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>parts</span><span class="s7">:</span><span class="s1"> </span><span class="s7">[{</span><span class="s1"> text</span><span class="s7">:</span><span class="s1"> msg</span><span class="s7">.</span><span class="s1">text </span><span class="s7">}]</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}));</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Add the current user message to the contents array</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>contents</span><span class="s7">.</span><span class="s1">push</span><span class="s7">({</span><span class="s1"> role</span><span class="s7">:</span><span class="s1"> </span><span class="s8">'user'</span><span class="s7">,</span><span class="s1"> parts</span><span class="s7">:</span><span class="s1"> </span><span class="s7">[{</span><span class="s1"> text</span><span class="s7">:</span><span class="s1"> userMessage </span><span class="s7">}]</span><span class="s1"> </span><span class="s7">});</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> payload </span><span class="s7">=</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>contents</span><span class="s7">:</span><span class="s1"> contents</span><span class="s7">,</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Optional: Add system instructions to define the bot's persona</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>systemInstruction</span><span class="s7">:</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p8"><span class="s16"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>parts</span><span class="s17">:</span><span class="s16"> </span><span class="s17">[{</span><span class="s16"> text</span><span class="s17">:</span><span class="s16"> </span><span class="s10">"You are Professor McGonnagal, a Biology Professor specializing in debunking common scientific misconceptions. Your first and ONLY response to the student MUST be a warm greeting, asking for their name, and confirming they are ready to begin the Misconception Cycle. Do NOT start the cycle with the misconception challenges yet. Once the student has provided their name and confirmed they are ready, you MUST immediately begin the structured cycle. The cycle is now focused on one topic at a time. 1. You will select ONE common scientific misconception (from biology, physics, or general science) and ask the student to explain that specific misconception (e.g., 'Explain why we have seasons'). 2. If the student's explanation is incorrect or incomplete, you MUST NOT provide the correct answer. Instead, ask a follow-up, probing question designed to guide the student toward self-correction. Continue this probing dialogue until the student has demonstrated a strong understanding of the concept. 3. Once the student has demonstrated correct understanding, only then congratulate them, provide a concise summary of the correct concept, and immediately start a new cycle (Steps 1 &amp; 2 repeated) by selecting ONE NEW misconception and asking the student to explain it."</span><span class="s16"> </span><span class="s17">}]</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">},</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>config</span><span class="s7">:</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Optional: You can enable Google Search grounding here if needed for real-time information</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>tools</span><span class="s7">:</span><span class="s1"> </span><span class="s7">[{</span><span class="s1"> </span><span class="s8">"google_search"</span><span class="s7">:</span><span class="s1"> </span><span class="s7">{}</span><span class="s1"> </span><span class="s7">}]</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">};</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> apiUrl </span><span class="s7">=</span><span class="s1"> </span><span class="s8">`</span><span class="s7">${</span><span class="s12">API_BASE_URL</span><span class="s7">}</span><span class="s8">?key=</span><span class="s7">${</span><span class="s12">API_KEY</span><span class="s7">}</span><span class="s8">`</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">try</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> response </span><span class="s7">=</span><span class="s1"> </span><span class="s11">await</span><span class="s1"> fetchWithRetry</span><span class="s7">(()</span><span class="s1"> </span><span class="s7">=&gt;</span><span class="s1"><span class="Apple-converted-space">Â </span></span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>fetch</span><span class="s7">(</span><span class="s1">apiUrl</span><span class="s7">,</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>method</span><span class="s7">:</span><span class="s1"> </span><span class="s8">'POST'</span><span class="s7">,</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>headers</span><span class="s7">:</span><span class="s1"> </span><span class="s7">{</span><span class="s1"> </span><span class="s8">'Content-Type'</span><span class="s7">:</span><span class="s1"> </span><span class="s8">'application/json'</span><span class="s1"> </span><span class="s7">},</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>body</span><span class="s7">:</span><span class="s1"> </span><span class="s12">JSON</span><span class="s7">.</span><span class="s1">stringify</span><span class="s7">(</span><span class="s1">payload</span><span class="s7">)</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">})</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">);</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> result </span><span class="s7">=</span><span class="s1"> </span><span class="s11">await</span><span class="s1"> response</span><span class="s7">.</span><span class="s1">json</span><span class="s7">();</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> text </span><span class="s7">=</span><span class="s1"> result</span><span class="s7">.</span><span class="s1">candidates</span><span class="s7">?.[</span><span class="s14">0</span><span class="s7">]?.</span><span class="s1">content</span><span class="s7">?.</span><span class="s1">parts</span><span class="s7">?.[</span><span class="s14">0</span><span class="s7">]?.</span><span class="s1">text</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">text</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">return</span><span class="s1"> text</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">else</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> errorMsg </span><span class="s7">=</span><span class="s1"> result</span><span class="s7">.</span><span class="s1">error</span><span class="s7">?.</span><span class="s1">message </span><span class="s7">||</span><span class="s1"> </span><span class="s8">"Model returned an empty or invalid response."</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">throw</span><span class="s1"> </span><span class="s11">new</span><span class="s1"> </span><span class="s12">Error</span><span class="s7">(</span><span class="s1">errorMsg</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">catch</span><span class="s1"> </span><span class="s7">(</span><span class="s1">e</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>console</span><span class="s7">.</span><span class="s1">error</span><span class="s7">(</span><span class="s8">"Gemini API call failed:"</span><span class="s7">,</span><span class="s1"> e</span><span class="s7">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>showError</span><span class="s7">(</span><span class="s1">"AI service failed to respond. Please try again."</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">return</span><span class="s1"> </span><span class="s11">null</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// --- EVENT HANDLERS ---</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* Handles the form submission.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>* @param {Event} e - The form submit event.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  </span>*/</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s11">async</span><span class="s1"> </span><span class="s11">function</span><span class="s1"> handleChatSubmit</span><span class="s7">(</span><span class="s1">e</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>e</span><span class="s7">.</span><span class="s1">preventDefault</span><span class="s7">();</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(!</span><span class="s1">isAuthReady</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>showError</span><span class="s7">(</span><span class="s1">"Authentication is still loading. Please wait a moment."</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">return</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> userMessage </span><span class="s7">=</span><span class="s1"> userInput</span><span class="s7">.</span><span class="s1">value</span><span class="s7">.</span><span class="s1">trim</span><span class="s7">();</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(!</span><span class="s1">userMessage </span><span class="s7">||</span><span class="s1"> isAITyping</span><span class="s7">)</span><span class="s1"> </span><span class="s11">return</span><span class="s7">;</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// 1. Disable input and set typing state</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>userInput</span><span class="s7">.</span><span class="s1">value </span><span class="s7">=</span><span class="s1"> </span><span class="s8">''</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>userInput</span><span class="s7">.</span><span class="s1">disabled </span><span class="s7">=</span><span class="s1"> </span><span class="s11">true</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>sendButton</span><span class="s7">.</span><span class="s1">disabled </span><span class="s7">=</span><span class="s1"> </span><span class="s11">true</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>isAITyping </span><span class="s7">=</span><span class="s1"> </span><span class="s11">true</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>renderChat</span><span class="s7">(</span><span class="s1">conversationHistory</span><span class="s7">);</span><span class="s1"> </span><span class="s13">// Renders the typing indicator</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// 2. Save user message to Firestore (which triggers UI update via onSnapshot)</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">await</span><span class="s1"> addMessageToFirestore</span><span class="s7">(</span><span class="s8">'user'</span><span class="s7">,</span><span class="s1"> userMessage</span><span class="s7">);</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// 3. Get AI response</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> aiResponseText </span><span class="s7">=</span><span class="s1"> </span><span class="s11">await</span><span class="s1"> getGeminiResponse</span><span class="s7">(</span><span class="s1">conversationHistory</span><span class="s7">,</span><span class="s1"> userMessage</span><span class="s7">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// 4. Save AI response to Firestore</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">aiResponseText</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">await</span><span class="s1"> addMessageToFirestore</span><span class="s7">(</span><span class="s8">'model'</span><span class="s7">,</span><span class="s1"> aiResponseText</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span><span class="s1"> </span><span class="s11">else</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Save a fallback error message if the AI failed</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â  Â  Â  </span></span><span class="s11">await</span><span class="s4"> addMessageToFirestore</span><span class="s7">(</span><span class="s1">'model'</span><span class="s7">,</span><span class="s4"> </span><span class="s1">"I'm sorry, I was unable to process your request. Please check the console for API errors."</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// 5. Reset state</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>isAITyping </span><span class="s7">=</span><span class="s1"> </span><span class="s11">false</span><span class="s7">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Remove the temporary typing indicator and re-render the chat</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">const</span><span class="s1"> typingIndicator </span><span class="s7">=</span><span class="s1"> document</span><span class="s7">.</span><span class="s1">getElementById</span><span class="s7">(</span><span class="s8">'typing-indicator'</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s11">if</span><span class="s1"> </span><span class="s7">(</span><span class="s1">typingIndicator</span><span class="s7">)</span><span class="s1"> </span><span class="s7">{</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>typingIndicator</span><span class="s7">.</span><span class="s1">remove</span><span class="s7">();</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>userInput</span><span class="s7">.</span><span class="s1">disabled </span><span class="s7">=</span><span class="s1"> </span><span class="s11">false</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>sendButton</span><span class="s7">.</span><span class="s1">disabled </span><span class="s7">=</span><span class="s1"> </span><span class="s11">false</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>userInput</span><span class="s7">.</span><span class="s1">focus</span><span class="s7">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span></span><span class="s1">// Scroll to the bottom one last time to ensure the final message is visible</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>chatArea</span><span class="s7">.</span><span class="s1">scrollTop </span><span class="s7">=</span><span class="s1"> chatArea</span><span class="s7">.</span><span class="s1">scrollHeight</span><span class="s7">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s7">}</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">Â  Â  Â  Â  </span></span><span class="s1">// --- INITIALIZATION ---</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>chatForm</span><span class="s7">.</span><span class="s1">addEventListener</span><span class="s7">(</span><span class="s8">'submit'</span><span class="s7">,</span><span class="s1"> handleChatSubmit</span><span class="s7">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>initializeFirebase</span><span class="s7">();</span></p>
<p class="p6"><span class="s10"></span><br></p>
<p class="p1"><span class="s4"><span class="Apple-converted-space">Â  Â  </span></span><span class="s3">&lt;/</span><span class="s1">script</span><span class="s3">&gt;</span></p>
<p class="p1"><span class="s3">&lt;/</span><span class="s1">body</span><span class="s3">&gt;</span></p>
<p class="p1"><span class="s3">&lt;/</span><span class="s1">html</span><span class="s3">&gt;</span></p>
</body>
</html>
