<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .chat-container {
            max-height: 80vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .bot-message {
            background-color: #e0f2fe; /* Light Blue */
            color: #0c4a6e;
        }
        .user-message {
            background-color: #d1fae5; /* Light Green */
            color: #065f46;
        }
        .source-link {
            color: #1d4ed8;
            text-decoration: underline;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: block;
        }
        .source-container {
            border-top: 1px solid #bae6fd;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
        /* Custom scrollbar for aesthetics */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
    <!-- Firebase Imports for Authentication and Persistence -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        window.firebaseApp = {
            db: null,
            auth: null,
            appId: appId,
            initialAuthToken: initialAuthToken
        };
        
        const CHAT_COLLECTION = "chat_messages"; 
        
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.firebaseApp.db = db;
            window.firebaseApp.auth = auth;
            // setLogLevel('Debug'); // Uncomment for debugging
        }

        // Handle Authentication
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                let currentUserId = null;
                
                if (user) {
                    // 1. User is already authenticated
                    currentUserId = user.uid;
                } else {
                    // 2. User needs to sign in (anonymously or with custom token)
                    try {
                        const signInPromise = initialAuthToken 
                            ? signInWithCustomToken(auth, initialAuthToken)
                            : signInAnonymously(auth);
                        
                        const cred = await signInPromise; // Await the sign-in promise
                        currentUserId = cred.user.uid;

                    } catch (error) {
                        console.error("Firebase Sign-in Failed:", error);
                        // currentUserId remains null on failure
                    }
                }
                
                // 3. Dispatch ready state ONLY if we successfully obtained a userId and haven't already
                if (currentUserId && !isAuthReady) { 
                    userId = currentUserId;
                    isAuthReady = true;
                    // Start listening for chat messages
                    document.dispatchEvent(new CustomEvent('authReady')); 
                } else if (!currentUserId) {
                     console.error("Authentication failed: Could not determine user ID. Chat functions disabled.");
                }
            });
        }
    </script>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">
    <div id="chat-widget" class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6 flex flex-col h-[90vh]">
        
        <!-- Header -->
        <header class="pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg class="w-7 h-7 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.303L10 17.636l6.619 1.317a1 1 0 001.169-1.303l-7-14z"></path></svg>
                Professor McGonagall's Science Class
            </h1>
            <p class="text-sm text-gray-500 mt-1">Dispelling fallacies with academic rigor. Pay close attention, student.</p>
        </header>

        <!-- Chat Display Area -->
        <div id="messages" class="chat-container flex-grow py-4 space-y-4">
            <!-- Messages will be injected here by the Firestore listener -->
            <div id="auth-loading" class="text-center text-gray-500 italic mt-4">Initializing magic... Please wait for authentication.</div>
        </div>

        <!-- Input Area -->
        <div class="pt-4 border-t border-gray-200">
            <div class="flex space-x-3">
                <input type="text" id="user-input" placeholder="Type your query here..."
                       class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                       onkeydown="if(event.key === 'Enter') sendMessage()">
                <button id="send-button" onclick="sendMessage()" disabled
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150 flex items-center justify-center disabled:bg-indigo-400">
                    <span id="send-text">Send</span>
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const userInput = document.getElementById('user-input');
        const messagesContainer = document.getElementById('messages');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const authLoadingDiv = document.getElementById('auth-loading');

        // --- API & Model Configuration ---
        // !!! IMPORTANT: The API_KEY must be inserted here for external hosting. !!!
        const API_KEY = "AIzaSyB0VYddwvfQtAKVeD2zyk7PzVYvALMLiVg"; 
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        let chatHistory = [];
        const CHAT_COLLECTION = "chat_messages";
        
        // Wait for Firebase to initialize and authenticate before proceeding
        document.addEventListener('authReady', () => {
            authLoadingDiv.classList.add('hidden');
            sendButton.disabled = false;
            loadChatHistory();
        });


        /**
         * Utility function for exponential backoff retry logic.
         */
        async function withRetry(fn, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Max retries reached. Failing.");
                        throw error;
                    }
                    // Wait for 2^i seconds
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Adds a message bubble to the chat interface. (Used by onSnapshot)
         */
        function displayMessage(text, sender, sources = []) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `${sender}-message max-w-xs md:max-w-md p-3 rounded-xl shadow-md whitespace-pre-wrap`;
            
            if (sender === 'user') {
                messageBubble.classList.add('rounded-tr-none');
            } else {
                messageBubble.classList.add('rounded-tl-none');
            }

            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            messageBubble.innerHTML = formattedText;

            
            // Add sources if available
            if (sources && sources.length > 0) {
                const sourceContainer = document.createElement('div');
                sourceContainer.className = 'source-container mt-2 pt-2 border-t border-blue-200 text-xs text-gray-600';
                sourceContainer.innerHTML = '<strong>Sources:</strong>';
                
                const uniqueSources = new Map();
                sources.forEach(source => {
                    if (source.uri && source.title) {
                        uniqueSources.set(source.uri, source.title);
                    }
                });

                uniqueSources.forEach((title, uri) => {
                    const link = document.createElement('a');
                    link.className = 'source-link block truncate hover:text-blue-700';
                    link.href = uri;
                    link.target = '_blank';
                    link.textContent = title;
                    sourceContainer.appendChild(link);
                });
                
                messageBubble.appendChild(sourceContainer);
            }

            messageWrapper.appendChild(messageBubble);
            messagesContainer.appendChild(messageWrapper);

            // Scroll to the latest message
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        /**
         * Toggles the loading state for the button and input field.
         */
        function setLoading(isLoading) {
            if (isLoading) {
                sendText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                sendText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Saves a message (user or bot) to Firestore.
         */
        async function saveMessage(sender, text, sources = null) {
            const { db, appId } = window.firebaseApp;
            const userId = window.firebaseApp.auth?.currentUser?.uid;

            if (!db || !userId) {
                console.error("Firestore or user not ready. Cannot save message.");
                return;
            }
            const path = `artifacts/${appId}/users/${userId}/${CHAT_COLLECTION}`;
            try {
                await addDoc(collection(db, path), {
                    sender: sender,
                    text: text,
                    sources: sources,
                    timestamp: serverTimestamp() 
                });
            } catch (e) {
                console.error("Error adding document to Firestore: ", e);
            }
        }


        /**
         * Sets up a real-time listener for the chat history.
         */
        function loadChatHistory() {
            const { db, appId } = window.firebaseApp;
            const userId = window.firebaseApp.auth?.currentUser?.uid;

            if (!db || !userId) return;
            
            const path = `artifacts/${appId}/users/${userId}/${CHAT_COLLECTION}`;
            // Use orderBy to ensure messages are loaded in chronological order
            const q = query(collection(db, path), orderBy('timestamp', 'asc')); 

            onSnapshot(q, (snapshot) => {
                // Clear current messages and chatHistory to rebuild the entire state
                messagesContainer.innerHTML = '';
                chatHistory = []; 

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Rebuild the UI (passing 3 arguments: text, sender, sources)
                    displayMessage(data.text || '', data.sender, data.sources);
                    
                    // Rebuild the Gemini Chat History for API context
                    if (data.text) {
                        if (data.sender === 'bot') {
                            chatHistory.push({ role: "model", parts: [{ text: data.text }] });
                        } else if (data.sender === 'user') {
                            chatHistory.push({ role: "user", parts: [{ text: data.text }] });
                        }
                    }
                });
                
                // CRITICAL: Re-adding the welcome message logic here.
                if (snapshot.empty) {
                     const welcomeText = "Welcome, student. Before we commence our rigorous lesson on scientific misconceptions, please state your name.";
                     // Save the initial bot message to Firestore (onSnapshot will then display it)
                     saveMessage('bot', welcomeText);
                }

            }, (error) => {
                console.error("Firestore snapshot error:", error);
                displayMessage("A disturbance in the magic prevented us from loading your previous lessons.", 'bot');
            });
        }


        /**
         * Handles sending the user message to the Gemini API.
         */
        window.sendMessage = async function() {
            const query = userInput.value.trim();
            if (!query || !window.firebaseApp.auth?.currentUser?.uid) return;

            // 1. Save user message to Firestore (onSnapshot will handle displaying it)
            await saveMessage('user', query);
            
            // 2. Clear input and start loading
            userInput.value = '';
            setLoading(true);
            
            // 3. Construct API Payload
            const payload = {
                contents: chatHistory, // Use history rebuilt by the listener
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: "You are Professor Minerva McGonagal, a stern but fair professor from Hogwarts, with a special interest in teaching students the correct understanding of science. Your task is to act as a rigorous tutor on scientific misconceptions.\n\n**Protocol:**\n1. Use formal, professorial language, like a professor from Hogwarts.\n2. Do NOT provide the correct explanation yourself. Your purpose is to guide. Instead, guide the student with follow-up questions to help them reach the correct answer.\n3. Keep the conversation focused on a single scientific misconception until the student has provided a sufficiently accurate and complete explanation. Do not do the student's work for them." }]
                }
            };
            
            try {
                const response = await withRetry(async () => {
                    const res = await fetch(TEXT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const errorBody = await res.text();
                        throw new Error(`API request failed with status ${res.status}: ${errorBody}`);
                    }
                    return res.json();
                });

                const candidate = response.candidates?.[0];
                let botResponseText = candidate?.content?.parts?.[0]?.text;
                
                if (botResponseText) {
                    
                    // 4. Extract Grounding Sources
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // 5. Save bot text response to Firestore
                    await saveMessage('bot', botResponseText, sources); 

                } else {
                    await saveMessage('bot', "The Magic was too weak. Professor McGonagall couldn't formulate a response. Try again.", []);
                }

            } catch (error) {
                const errorMessage = "A critical network error occurred. Professor McGonagall is currently unable to receive owl post. (Hint: Ensure you have inserted a valid API key and are running the file from a web server.)";
                await saveMessage('bot', errorMessage, []);
                console.error("Gemini API call failed:", error);
            } finally {
                setLoading(false); // Stop loading after all steps are complete
            }
        };

        // Expose function to global scope for HTML inline access
        window.sendMessage = sendMessage;
    </script>
</body>
</html>
